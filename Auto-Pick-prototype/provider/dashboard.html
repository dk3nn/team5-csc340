<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Dealership Seller Dashboard</title>
  <link rel="stylesheet" href="../dashboard.css">
  <link rel="stylesheet" href="../home.css">
  <script src="../dashboard.js"></script>
</head>
<body>

    <div id="home-body" style="overflow: hidden;">
        <div id="navbar">
            <h2 id="name">Auto-Pick</h2>
            <div id="navbar-links">
                <a href="../home.html">Home</a>
                <a href="#">About</a>
                <a href="#">Contact</a>
            </div>
            <div id="btn-container">
                <a id="dealerUsername"></a>
            </div>
        </div>
        <div id="heading">
            <h1 style="text-align: center;">Welcome to Auto-Pick</h1>
            <p style="text-align: center;">Step to finding a new car</p>
        </div>

    <div id="dashboard-body">
    <div class="sidebar">
        <ul>
        <li><button onclick="menuBtn('dashboard')" class="menu-btn">Dashboard</button></li>
        <li><button onclick="menuBtn('inventory')" class="menu-btn">Inventory</button></li>
        <li><button onclick="menuBtn('finance')" class="menu-btn">Finance</button></li>
        <li><button onclick="menuBtn('add-new-car')" class="menu-btn">Add New Car</button></li>
        </ul>
    </div>

    <div class="main-content">

        <div id="dashboard">
            <div class="header">
            <h1 style="margin-top: 0px;">Auto-Pick Seller Dashboard</h1>
            </div>
            <div class="dashboard-cards">
                
                <div class="card">
                    <h3>Total Vehicles Sold</h3>
                    <p id="total-vehicles-sold"></p>
                </div>
                
                <div class="card">
                    <h3>Vehicles in the Shop</h3>
                    <p id="vehicles-in-the-shop"></p>
                </div>

                
                <div class="card">
                    <h3>Total Profit</h3>
                    <p id="total-profit"></p>
                </div>
                
                <div class="card">
                    <h3>This Yearâ€™s Profit</h3>
                    <p id="this-year-profit"></p>
                </div>

                
                <div class="card">
                    <h3>Cars Sold This Month</h3>
                    <p id="this-month-deals"></p>
                </div>      
            </div>
        </div>

        <div id="inventory">
            <h2>Inventory</h2>
            <div id="inventory-ribbon">
            <label>Search
                <input id="search" type="text" name="inventory-search">
            </label>
            <label for="filter-values">Filter
            <select id="filter-values">
                <option selected value="All">All</option>
                <option value="Sold">Sold</option>
                <option value="Unsold">Unsold</option>
            </select>
            </label>
            </div>

            
            <div id="dashboard-car-listings">

            </div>
        </div>

        <div id="finance">
            <h2>Finance</h2>
            <h3 style="text-align: center;">Due Payments List</h3>
            <table id="payment-table">
            <thead>
                <td>User name</td>
                <td>Payment amount</td>
                <td>Due Date</td>
                <td>Vehicle sold</td>
                <td>User Contact</td>
            </thead>
            
            
            </table>
        </div>

        <div id="add-new-car">
            <form id="add-vehicle-form">
            <h1 id="form-heading" style="text-align: center;">Add New Vehicle</h1>

            <fieldset>
                <legend>VIN Lookup</legend>
                <div class="form-group">
                    <label for="vin-input">VIN</label>
                    <div class="vin-input-group">
                        <input type="text" id="vin-input" name="vin" required maxlength="17" minlength="17">
                        <button type="button" id="vin-fetch-btn" class="btn btn-secondary">Fetch Info</button>
                    </div>
                </div>
            </fieldset>

            <input type="hidden" id="vehicle-id" name="id">
            <input type="hidden" id="dealer-id" name="dealerId">

            <fieldset>
                <legend>Core Details</legend>
                <div class="form-group">
                    <label for="make">Make</label>
                    <input type="text" id="make" name="make" required>
                </div>
                <div class="form-group">
                    <label for="model">Model</label>
                    <input type="text" id="model" name="model" required>
                </div>
                <div class="form-group">
                    <label for="trim">Trim</label>
                    <input type="text" id="trim" name="trim" required>
                </div>
                <div class="form-group">
                    <label for="year">Year</label>
                    <input type="number" id="year" name="year" required min="1900" max="2099">
                </div>
                <div class="form-group">
                    <label for="color">Color</label>
                    <input type="text" id="color" name="color" required>
                </div>
                <div class="form-group">
                    <label for="price">Price ($)</label>
                    <input type="number" id="price" name="price" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="cost">Cost ($)</label>
                    <input type="number" id="cost" name="cost" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="mileage">Mileage</label>
                    <input type="number" id="mileage" name="mileage" required min="0">
                </div>
            </fieldset>

            <fieldset>
                <legend>Specifications</legend>
                <div class="form-group">
                    <label for="transmission">Transmission</label>
                    <input list="transmission-options" id="transmission" name="transmission" required>
                    <datalist id="transmission-options">
                        <option value="Automatic"></option>
                        <option value="Manual"></option>
                        <option value="CVT"></option>
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="fuelType">Fuel Type</label>
                    <input list="fuelType-options" id="fuelType" name="fuelType" required>
                    <datalist id="fuelType-options">
                        <option value="Gasoline"></option>
                        <option value="Diesel"></option>
                        <option value="Electric"></option>
                        <option value="Hybrid"></option>
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="bodyType">Body Type</label>
                    <input list="bodyType-options" id="bodyType" name="bodyType" required>
                    <datalist id="bodyType-options">
                        <option value="Sedan"></option>
                        <option value="SUV"></option>
                        <option value="Truck"></option>
                        <option value="Coupe"></option>
                        <option value="Hatchback"></option>
                        <option value="Van/Minivan"></option>
                        <option value="Wagon"></option>
                        <option value="Convertible"></option>
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="numberOfDoors">Doors</label>
                    <input list="numberOfDoors-options" id="numberOfDoors" name="numberOfDoors" required>
                    <datalist id="numberOfDoors-options">
                        <option value="2"></option>
                        <option value="3"></option>
                        <option value="4"></option>
                        <option value="5"></option>
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="driveType">Drive Type</label>
                    <input list="driveType-options" id="driveType" name="driveType" required>
                    <datalist id="driveType-options">
                        <option value="FWD">Front-Wheel Drive (FWD)</option>
                        <option value="RWD">Rear-Wheel Drive (RWD)</option>
                        <option value="AWD">All-Wheel Drive (AWD)</option>
                        <option value="4WD">4-Wheel Drive (4WD)</option>
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="engineSize">Engine Size</label>
                    <input type="text" id="engineSize" name="engineSize" placeholder="e.g., 2.0L I4 or V8" required>
                </div>
            </fieldset>

            <fieldset>
                <legend>Media & Status</legend>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" placeholder="Add extra details..."></textarea>
                </div>
                <div class="form-group">
                    <label for="imageUrl">Image URL</label>
                    <input type="url" id="imageUrl" name="imageUrl" placeholder="https://example.com/image.jpg">
                </div>
            </fieldset>
            
            <button type="submit" id="save-form-btn" class="btn btn-primary">Add Vehicle</button>
        </form>
        </div>
    


        <div id="sell-form">
            <div class="sell-form-content">
                <h2>Sell Vehicle</h2>
                <form id="sell-vehicle-form">
                    <input type="hidden" id="sell-vehicle-id" name="vehicleId">
                    <div class="form-group">
                        <label for="customer-name">Customer Name</label>
                        <select id="customer-name-options" name="customerCId" required>
                            <option value="" disabled selected>Select a customer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="final-amount">Final Sale Amount ($)</label>
                        <input type="number" id="final-amount" name="dealAmount" required min="0" step="1.00">
                    </div>
                    <label for="isfinanced">
                        <input type="checkbox" id="isfinanced" name="isFinanced">
                        Is the purchase financed for 12 months?
                    </label>
                    <div class="form-group">
                        <label for="down-payment">Down Payment ($):</label>
                        <input type="number" id="down-payment" name="downPayment" required min="0" step="1.00" disabled>
                    </div>
                    <button type="submit" class="btn btn-primary">Confirm Sale</button>
                </form>
            </div>
        </div>
    </div>
    </div>
    <div id="loading-div">
        <div class="loader"></div>

    </div>
    <div id="footer">
            <p>Copyright 2025</p>
        </div>
</div>

  <script>
    //global variables
    const editForm = document.createElement('add-vehicle-form');
    const urlParams = new URLSearchParams(window.location.search);
    const dealerId = urlParams.get('dealerId');


    // Dashboard statistics
    fetch(`http://127.0.0.1:8080/api/vehicles/dealer/soldCount/${dealerId}`)
    .then(response => response.json())
    .then(totalSold => {
        document.getElementById('total-vehicles-sold').textContent = totalSold;
    });

    fetch(`http://127.0.0.1:8080/api/vehicles/dealer/unsoldCount/${dealerId}`)
    .then(response => response.json())
    .then(totalUnsold => {
        document.getElementById('vehicles-in-the-shop').textContent = totalUnsold;
    });

    fetch(`http://127.0.0.1:8080/api/deals/dealer/yearlysales/${dealerId}`)
    .then(response => response.json())
    .then(totalProfit => {
        document.getElementById('this-year-profit').textContent = `$${totalProfit}`;
    });

    fetch(`http://127.0.0.1:8080/api/deals/dealer/monthlydeals/${dealerId}`)
    .then(response => response.json())
    .then(totalDeals => {
        document.getElementById('this-month-deals').textContent = totalDeals;
    });

    fetch(`http://127.0.0.1:8080/api/deals/dealer/totalprofit/${dealerId}`)
    .then(response => response.json())
    .then(totalProfit => {
        document.getElementById('total-profit').textContent = `$${totalProfit}`;
    });


    // Get username
    fetch(`http://127.0.0.1:8080/api/dealers/${dealerId}`)
    .then(response => response.json())  
    .then(dealer => {
        const dealerUsername = document.getElementById('dealerUsername');
        dealerUsername.textContent = dealer.name;
        dealerUsername.href = `../profile-detail.html?dealerId=${dealer.id}`;
    });

    // Car listings in the inventory section
    container = document.getElementById('dashboard-car-listings')
    fetch("http://127.0.0.1:8080/api/vehicles/dealer/" + dealerId)
        .then(response => response.json())
        .then(carInventory => { 
            populateInventory(carInventory);
    });

    //filter and search functionality
    const filterSelect = document.getElementById('filter-values');
    const searchInput = document.getElementById('search');
   ;

    function populateInventory(carInventory){
        container.innerHTML = '';
        carInventory.forEach(car => { 
            const card = document.createElement('div');
            card.className = 'car-card';

            const img = document.createElement('img');
            img.src = car.imageUrl;
            img.alt = name

            const cardTextArea = document.createElement('div')
            cardTextArea.className = "card-text-area"

            const cardHeading = document.createElement('h3');
            cardHeading.textContent = car.make + " " + car.model + " " + car.trim +" " + car.year;

            const carMilage = document.createElement('p');
            carMilage.innerHTML = "<strong>Milage: </strong>" + car.mileage;

            const carEngineType = document.createElement('p');
            carEngineType.innerHTML = "<strong>Engine: </strong>" + car.engineSize

            const btnContainer = document.createElement('div')
            btnContainer.className = 'card-btn-container'

            const sellBtn = document.createElement('button');
            if(car.sold){
                sellBtn.disabled = true;
                sellBtn.textContent = "Sold";
                sellBtn.className = 'sold-btn'
            }else{
                sellBtn.textContent = "Sell";
                sellBtn.className = 'sell-btn';
            }
            sellBtn.vehicleId = car.id;
            sellBtn.type ="button";

            const detailButton = document.createElement('button');
            detailButton.textContent = "View Details";
            detailButton.type ="button";

            const deleteButton = document.createElement('button');
            deleteButton.textContent = "Delete";
            deleteButton.type ="button";

            const editButton = document.createElement('button');
            editButton.textContent = "Edit";
            editButton.value = car.id;
            editButton.type ="button";


            //button functionality
            deleteButton.addEventListener('click', async () => {
                try {
                    const response = await fetch(`http://127.0.0.1:8080/api/vehicles/${car.id}`, {
                        method: 'DELETE',
                    });
                    if (response.ok) {
                        alert('Vehicle deleted successfully!');
                        card.remove();
                    } else {
                        alert('Failed to delete vehicle.');
                    }
                } catch (error) {
                    console.error('Error deleting vehicle:', error);
                    alert('Failed to delete vehicle. Please try again later.');
                }
            });

            detailButton.addEventListener('click', () => {
                window.location.href = `vehicle-details.html?vehicleId=${car.id}`;
            });

            sellBtn.addEventListener('click', () => {
                const vehicleId = sellBtn.vehicleId;
                document.getElementById('sell-vehicle-id').value = vehicleId;
                menuBtn('sell-form');
            });

            //editting button functionality
            const inventoryDiv = document.getElementById('inventory');
            editButton.addEventListener('click', (event) => {
                const carId = event.target.value;
                inventoryDiv.style.display = 'none';
                saveFormBtn = document.getElementById('save-form-btn');
                saveFormBtn.textContent = "Save Changes";
                formHeading = document.getElementById('form-heading');
                formHeading.textContent = "Edit Vehicle Details";
                addNewCarDiv = document.getElementById('add-new-car');
                addNewCarDiv.style.display = 'block';
                fetch(`http://127.0.0.1:8080/api/vehicles/${carId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('make').value = data.make || '';
                    document.getElementById('model').value = data.model || '';
                    document.getElementById('year').value = data.year || '';
                    document.getElementById('trim').value = data.trim || '';
                    document.getElementById('bodyType').value = data.bodyType || '';
                    document.getElementById('engineSize').value = data.engineSize || '';
                    document.getElementById('fuelType').value = data.fuelType || '';
                    document.getElementById('transmission').value = data.transmission || '';
                    document.getElementById('bodyType').value = data.bodyType || '';
                    document.getElementById('numberOfDoors').value = data.numberOfDoors || '';
                    document.getElementById('driveType').value = data.driveType || '';
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('imageUrl').value = data.imageUrl || '';
                    document.getElementById('color').value = data.color || '';
                    document.getElementById('price').value = data.price || '';
                    document.getElementById('cost').value = data.cost || '';
                    document.getElementById('mileage').value = data.mileage || '';
                    document.getElementById('vin-input').value = data.vin || '';
                    document.getElementById('vehicle-id').value = data.id || '';
                    document.getElementById('dealer-id').value = data.dealer.id || '';
                });
            });

            btnContainer.append(sellBtn);
            if(!car.sold){
                btnContainer.append(editButton);
                btnContainer.append(deleteButton);
            }
            btnContainer.append(detailButton);

            container.appendChild(card);
            card.appendChild(img);
            card.appendChild(cardTextArea);
            cardTextArea.appendChild(cardHeading);
            cardTextArea.appendChild(carMilage);
            cardTextArea.appendChild(carEngineType);
            card.appendChild(btnContainer);     
        });
    }


    // VIN Lookup Functionality
    const vinFetchBtn = document.getElementById('vin-fetch-btn');
    vinFetchBtn.addEventListener('click', async () => {
        const vin = document.getElementById('vin-input').value.trim();
        if (vin.length !== 17) {
            alert('Please enter a valid 17-character VIN.');
            return;
        }

        try {
            const response = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vin}?format=json`);
            const data = await response.json();
            const result = data.Results[0];
            console.log(result);

            document.getElementById('make').value = result.Make || '';
            document.getElementById('model').value = result.Model || '';
            document.getElementById('year').value = result.ModelYear || '';
            document.getElementById('trim').value = result.Trim || '';
            document.getElementById('bodyType').value = result.BodyClass || '';
            document.getElementById('engineSize').value = `${result.DisplacementL}L` || '';
            document.getElementById('fuelType').value = result.FuelTypePrimary || '';
            document.getElementById('transmission').value = result.TransmissionStyle || '';
            document.getElementById('bodyType').value = result.BodyClass || '';
            document.getElementById('numberOfDoors').value = result.Doors || '';
            document.getElementById('driveType').value = result.DriveType || '';
            document.getElementById('description').value = result.Note || '';

        } catch (error) {
            console.error('Error fetching VIN data:', error);
            alert('Failed to fetch vehicle data. Please try again later.');
        }
    });

    //edit vehicle form submission handling
    async function formSubmitionHandler(url, method, formData, message) {
        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            });
            if (response.ok) {
                alert(`Vehicle ${message} successfully!`);
                window.location.reload();
            } else {
                const errorData = await response.json();
                alert('Failed to' + message + ' vehicle: ' + (errorData.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error' + message +' vehicle data:', error);   
            alert('Failed to ' + message +' vehicle data. Please try again later.');
        }
    };


    //New Vehicle Form Submission Handling
    const addVehicleForm = document.getElementById('add-vehicle-form');
    addVehicleForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const formData = new FormData(addVehicleForm);
        const vehicleData = Object.fromEntries(formData.entries());
        if(document.getElementById('save-form-btn').textContent === "Save Changes"){
            vehicleData.dealer = {id : dealerId};
            formSubmitionHandler(`http://127.0.0.1:8080/api/vehicles/${vehicleData.id}`, 'PUT', vehicleData, 'edit');
        }else{
            vehicleData.dealer = {id : dealerId};
            delete vehicleData.id;
           formSubmitionHandler(`http://127.0.0.1:8080/api/vehicles`, 'POST', vehicleData, 'add');
        }
    }); 




    // payments handling
    const paymentTable = document.getElementById('payment-table');
    fetch("http://127.0.0.1:8080/api/payment")
    .then(response => response.json())
    .then(data => {
        data.forEach(payment => {
            const row = document.createElement('tr');

            const userNameCell = document.createElement('td');
            userNameCell.textContent = payment.deal.customer.name;
            row.appendChild(userNameCell);

            const amountCell = document.createElement('td');
            amountCell.textContent = `$${payment.amount.toFixed(2)}`;
            row.appendChild(amountCell);

            const dueDateCell = document.createElement('td');
            dueDateCell.textContent = new Date(payment.dueDate).toLocaleDateString();
            row.appendChild(dueDateCell);

            const vehicleCell = document.createElement('td');
            vehicleCell.textContent = `${payment.deal.vehicle.make} ${payment.deal.vehicle.model} ${payment.deal.vehicle.year}`;
            row.appendChild(vehicleCell);

            const contactCell = document.createElement('td');
            contactCell.textContent = payment.deal.customer.phone;
            row.appendChild(contactCell);

            paymentTable.appendChild(row);
        });
    });

    // get customers for sell form
    fetch("http://127.0.0.1:8080/api/customers")
    .then(response => response.json())
    .then(customers => {
        const customerSelect = document.getElementById('customer-name-options');
        customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.cId;
            option.textContent = customer.name;
            customerSelect.appendChild(option);
        });
    });

    // down payment handling
    const downPaymentInput = document.getElementById('down-payment');
    const isFinancedCheckbox = document.getElementById('isfinanced');
    isFinancedCheckbox.addEventListener('change', () => {
        if (isFinancedCheckbox.checked) {
            downPaymentInput.disabled = false;
        } else {
            downPaymentInput.disabled = true;
            downPaymentInput.value = document.getElementById('final-amount').value;
        }
    });

    // sell form submission handling
    const sellVehicleForm = document.getElementById('sell-vehicle-form');
    sellVehicleForm.addEventListener('submit', async (event) => {
        document.getElementById('loading-div').style.display = 'block';
        event.preventDefault();

        const formData = new FormData(sellVehicleForm);
        const sellData = Object.fromEntries(formData.entries());
        sellData.isFinanced = document.getElementById('isfinanced').checked ? true : false;
        sellData.dealer = {id: dealerId};
        sellData.vehicle = {id: sellData.vehicleId};
        sellData.customer = {cId: sellData.customerCId};
        delete sellData.customerCId;
        delete sellData.vehicleId;
        sellData.dealDate = new Date().toISOString();
        if(!sellData.isFinanced){
            sellData.downPayment = sellData.dealAmount;
        }else{
            sellData.downPayment = sellData.downPayment;
        }
        try {
            const response = await fetch('http://127.0.0.1:8080/api/deals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(sellData),
            });
            if (response.ok) {
                alert('Vehicle sold successfully!');
                window.location.reload();
            } else {
                const errorData = await response.json();
                alert('Failed to sell vehicle: ' + (errorData.message || 'Unknown error'));
                document.getElementById('loading-div').style.display = 'none';
            }
        } catch (error) {
            console.error('Error selling vehicle:', error);
            alert('Failed to sell vehicle. Please try again later.');
            document.getElementById('loading-div').style.display = 'none';
        }
    });

    

  </script>
</body>
</html>
