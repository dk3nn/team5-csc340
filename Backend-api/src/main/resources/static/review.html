<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="home.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="review.css">
    <script src="samplecardata.js"></script>
    <title>Auto-Pick Home</title>
</head>
<body>
    <div id="home-body">
        <div id="navbar">
            <h2 id="name">Auto-Pick</h2>
            <div id="navbar-links">
                <a href="home.html">Home</a>
                <a href="#">About</a>
                <a href="#">Contact</a>
            </div>
        </div>
        <div id="heading">
            <h1 style="text-align: center;">Welcome to Auto-Pick Dealer Information</h1>
            <p style="text-align: center;"></p>
        </div>
        
        <div id="outer-container">
            <div id="dealer-info">
                <div id="dealer-details"></div>
                <div id="dealer-reviews">
                    <div class="review-card-container">
                        
                    </div>
                    <div class="add-review-section">
                        <h3>Add a Review</h3>
                        <textarea id="review-text" rows="4" cols="50" placeholder="Write your review here..."></textarea>
                        <br>
                        <button id="submit-review-btn" type="button">Submit Review</button>
                    </div>
                </div>
            </div>
            <h2>Dealer's Vehicle Listings</h2>
            <div id="car-listings">

            </div>
        </div>
        <div id="footer">
            <p>Copyright 2025</p>
        </div>
    </div>

    <script>
        // get url parameters
        const urlParams = new URLSearchParams(window.location.search);
        const dealerId = urlParams.get('id');

        const outerContainer = document.getElementById('outer-container');
        const dealerInfo = document.getElementById('dealer-details');
        container = document.getElementById('car-listings');

        // fetch dealer information
        fetch(`http://localhost:8080/api/dealers/${dealerId}`)
            .then(response => response.json())
            .then(dealer => {

                const dealerName = document.createElement('h3');
                dealerName.textContent = dealer.name;

                const dealerEmail = document.createElement('p');
                dealerEmail.innerHTML = `<strong>Email: </strong>${dealer.email}`;

                const dealerPhone = document.createElement('p');
                dealerPhone.innerHTML = `<strong>Phone: </strong>${dealer.phoneNumber}`;

                const dealerAddress = document.createElement('p');
                dealerAddress.innerHTML = `<strong>Address: </strong>${dealer.address}`;

                dealerInfo.appendChild(dealerName);
                dealerInfo.appendChild(dealerEmail);
                dealerInfo.appendChild(dealerPhone);
                dealerInfo.appendChild(dealerAddress);

                
            });

            // Get dealers vehicles
            fetch(`http://localhost:8080/api/vehicles/dealer/${dealerId}`)
            .then(response => response.json())
            .then(vehicles => {
                populateCars(vehicles);

            })
            .catch(error => {
                console.error('Error fetching dealer vehicles:', error);
            });


        function populateCars(carInventory) {
            carInventory.forEach(car => { 
                    const card = document.createElement('div');
                    card.className = 'car-card';

                    const img = document.createElement('img');
                    img.src = car.imageUrl;
                    img.alt = name

                    const cardTextArea = document.createElement('div')
                    cardTextArea.className = "card-text-area"

                    const cardHeading = document.createElement('h3');
                    cardHeading.textContent = car.make + " " + car.model + " " + car.trim +" " + car.year;

                    const carMilage = document.createElement('p');
                    carMilage.innerHTML = "<strong>Milage: </strong>" + car.mileage;

                    const carEngineType = document.createElement('p');
                    carEngineType.innerHTML = "<strong>Engine Size: </strong>" + car.engineSize;

                    const carPrice = document.createElement('p');
                    carPrice.innerHTML = "<strong>Price: </strong>$" + car.price;

                    const btnContainer = document.createElement('div')
                    btnContainer.className = 'card-btn-container'


                    const detailButton = document.createElement('button');
                    detailButton.textContent = "View Details";
                    detailButton.type ="button";

                    btnContainer.append(detailButton);

                    container.appendChild(card);
                    card.appendChild(img);
                    card.appendChild(cardTextArea);
                    cardTextArea.appendChild(cardHeading);
                    cardTextArea.appendChild(carMilage);
                    cardTextArea.appendChild(carEngineType);
                    cardTextArea.appendChild(carPrice);
                    card.appendChild(btnContainer);

                });
        }


        // Fetch and display reviews
        fetch(`http://localhost:8080/reviews/dealer/${dealerId}`)
            .then(response => response.json())
            .then(reviews => {
                const reviewContainer = document.querySelector('.review-card-container');
                reviews.forEach(review => {
                    const reviewCard = document.createElement('div');
                    reviewCard.className = 'review-card';

                    const reviewerName = document.createElement('h4');
                    reviewerName.textContent = review.customer.name;

                    const reviewText = document.createElement('p');
                    reviewText.textContent = review.comment;

                    reviewCard.appendChild(reviewerName);
                    reviewCard.appendChild(reviewText);
                    reviewContainer.appendChild(reviewCard);
                });
            })
            .catch(error => {
                console.error('Error fetching reviews:', error);
            });

        //session storage for customer id
        let customerId;
        fetch('http://127.0.0.1:8080/customer/session')
            .then(response => response.json())
            .then(customer => {
                if (customer.cId) {
                    customerId = customer.cId;
                } else {
                    customerId = null;
                }
            })
            .catch(error => {
                console.error('Error fetching customer session:', error);
            });

        // Handle review submission
        const submitReviewBtn = document.getElementById('submit-review-btn');
        submitReviewBtn.addEventListener('click', () => {
            const reviewText = document.getElementById('review-text').value;
            if (customerId == null) {
                alert('You must be logged in as a customer to submit a review.');
                window.location.href = '/login';
                return;
            }

            const reviewData = {
                comment: reviewText,
                dealer: { id: parseInt(dealerId) },
                customer: { cId: parseInt(customerId) }
            };

            fetch('http://localhost:8080/reviews', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reviewData)
            })
            .then(response => {
                if (response.ok) {
                    alert('Review submitted successfully!');
                    location.reload(); // Reload to show the new review
                } else {
                    alert('Failed to submit review.');
                }
            })
            .catch(error => {
                console.error('Error submitting review:', error);
            });
        });
    </script>
</body>
</html>
